name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types: [completed]
    branches: ["main"]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (git SHA or 'latest')"
        required: false
        default: "latest"
        type: string
      environment:
        description: "Target environment"
        required: false
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if the triggering build succeeded, or if manually dispatched
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    environment:
      name: ${{ inputs.environment || 'production' }}

    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install SOPS and age
        run: |
          # Install age
          AGE_VERSION="v1.3.1"
          curl -fsSL "https://github.com/FiloSottile/age/releases/download/${AGE_VERSION}/age-${AGE_VERSION}-linux-amd64.tar.gz" | tar -xz
          sudo mv age/age age/age-keygen /usr/local/bin/

          # Install SOPS
          SOPS_VERSION="v3.11.0"
          curl -fsSL "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" -o /usr/local/bin/sops
          chmod +x /usr/local/bin/sops

      - name: Decrypt secrets with SOPS
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          sops decrypt -i k8s/base/secret.yaml
      
      - name: Generate build version
        id: version
        run: |
          BUILD_VERSION="$(date -u +'%Y.%m.%d.%H%M').$(git rev-parse --short HEAD)"
          echo "build_version=${BUILD_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update image tags with Kustomize
        working-directory: k8s/base
        run: |
          # Replace placeholder OWNER with actual repository owner
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          BUILD_VERSION=${{ steps.version.outputs.build_version }}

          # Set the image tag
          kustomize edit set image \
            "ghcr.io/OWNER/photosafe-backend=ghcr.io/${REPO_OWNER}-backend:${{ steps.tag.outputs.tag }}" \
            "ghcr.io/OWNER/photosafe-frontend=ghcr.io/${REPO_OWNER}-frontend:${{ steps.tag.outputs.tag }}"
          
          kustomize edit add annotation app.kubernetes.io/version:${BUILD_VERSION} --force

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -k k8s/base/

      - name: Wait for backend rollout
        run: |
          kubectl rollout status deployment/backend -n photosafe --timeout=300s

      - name: Wait for frontend rollout
        run: |
          kubectl rollout status deployment/frontend -n photosafe --timeout=300s

      - name: Verify deployment
        run: |
          echo "--- Pods ---"
          kubectl get pods -n photosafe
          echo ""
          echo "--- Services ---"
          kubectl get svc -n photosafe
          echo ""
          echo "--- Ingress ---"
          kubectl get ingress -n photosafe
